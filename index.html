<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>PhoenixVA ‚Äî Voice + Text Portal</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 40px; }
      h1 { margin-top: 0; }
      #row { margin: 8px 0; }
      input[type="text"] { width: 360px; padding: 8px; font-size: 16px; }
      button { padding: 10px 16px; font-size: 16px; margin-right: 6px; }
      #output { margin-top: 16px; padding: 12px; border: 1px solid #ddd; min-height: 90px; white-space: pre-wrap; }
      #status { color:#555; }
    </style>
  </head>
  <body>
    <h1>PhoenixVA ‚Äî Voice + Text Portal</h1>

    <!-- Press-to-talk (hold) -->
    <div id="row">
      <button id="pressBtn">üéôÔ∏è Hold to Talk</button>
      <span id="status"></span>
    </div>

    <!-- Type-to-send -->
    <div id="row">
      <input id="textInput" type="text" placeholder="Type your message‚Ä¶" />
      <button id="sendBtn">Send</button>
    </div>

    <div id="output">Ready.</div>

    <script>
      const pressBtn  = document.getElementById('pressBtn');
      const sendBtn   = document.getElementById('sendBtn');
      const textInput = document.getElementById('textInput');
      const output    = document.getElementById('output');
      const statusEl  = document.getElementById('status');

      // ----- Text ‚Üí Chat -----
      async function sendMessage(msg) {
        output.textContent = 'Thinking‚Ä¶';
        try {
          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg })
          });
          const data = await res.json();
          output.textContent = (data.reply || data.error || '(no reply)');
        } catch {
          output.textContent = 'Network error';
        }
      }

      sendBtn.onclick = () => {
        const msg = textInput.value.trim();
        if (!msg) return;
        textInput.value = '';
        sendMessage(msg);
      };
      textInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendBtn.click(); });

      // ----- Voice (press-and-hold) ‚Üí Whisper ‚Üí Chat -----
      let mediaRecorder, audioChunks = [];

      async function startRecording() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          // Build a single Blob of audio and send RAW to backend.
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          statusEl.textContent = 'Transcribing‚Ä¶';
          output.textContent = 'Transcribing‚Ä¶';

          try {
            // Send RAW audio; backend will construct FormData for Whisper.
            const tr = await fetch('/api/transcribe', {
              method: 'POST',
              headers: { 'Content-Type': 'audio/webm' },
              body: blob
            });
            const tdata = await tr.json();
            const text = tdata.text || '';
            if (!text) {
              statusEl.textContent = 'No speech detected';
              output.textContent = 'No speech detected.';
              return;
            }

            statusEl.textContent = 'Asking‚Ä¶';
            output.textContent = 'You said: ' + text + '\nThinking‚Ä¶';

            const cr = await fetch('/api/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: text })
            });
            const cdata = await cr.json();
            const reply = cdata.reply || '(no reply)';
            output.textContent = 'You said: ' + text + '\nAssistant: ' + reply;
            statusEl.textContent = 'Ready';
          } catch {
            statusEl.textContent = 'Error';
            output.textContent = 'Error during transcription or chat.';
          }
        };
        mediaRecorder.start();
      }

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      }

      // Press-and-hold UX (mouse + touch)
      pressBtn.onmousedown = async () => {
        statusEl.textContent = 'Recording‚Ä¶ (hold)';
        await startRecording();
      };
      pressBtn.onmouseup = () => {
        statusEl.textContent = 'Processing‚Ä¶';
        stopRecording();
      };
      pressBtn.onmouseleave = () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          statusEl.textContent = 'Processing‚Ä¶';
          stopRecording();
        }
      };
      pressBtn.ontouchstart = async (e) => {
        e.preventDefault();
        statusEl.textContent = 'Recording‚Ä¶ (hold)';
        await startRecording();
      };
      pressBtn.ontouchend = (e) => {
        e.preventDefault();
        statusEl.textContent = 'Processing‚Ä¶';
        stopRecording();
      };
    </script>
  </body>
</html>
