<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Google Connection Test</title>
  <style>
    .ok { color: green; }
    .bad { color: red; }
  </style>
</head>
<body>
  <h2>Connection Status: <span id="gStatus" class="bad">Not connected ❌</span></h2>
  <button id="btnCheck">Check Google Status</button>

  <section>
    <form id="formDriveList">
      <div>
        <input name="folderName" placeholder="Optional folder" />
        <input name="mimeType" placeholder="Optional mimeType" />
      </div>
      <button class="btn" type="submit">Drive · List</button>
    </form>

    <form id="formRead">
      <div class="grid-2">
        <input name="fileName" placeholder="Spreadsheet name" required />
        <input name="folderName" placeholder="Optional folder" />
      </div>
      <div class="grid-2">
        <input name="tab" placeholder="Tab (default Sheet1)" />
        <input name="range" placeholder="Range (e.g. A:Z or A2:E50)" />
      </div>
      <button class="btn" type="submit">Sheets · Read</button>
    </form>

    <form id="formUpdateCell">
      <div class="grid-2">
        <input name="fileName" placeholder="Spreadsheet name" required />
        <input name="folderName" placeholder="Optional folder" />
      </div>
      <div class="grid-2">
        <input name="tab" placeholder="Tab (default Sheet1)" />
        <input name="cell" placeholder="Cell (e.g. B7)" />
      </div>
      <input name="value" placeholder="Value" />
      <button class="btn" type="submit">Sheets · Update Cell</button>
    </form>

    <form id="formDocRead">
      <div class="grid-2">
        <input name="docName" placeholder="Doc name" required />
        <input name="folderName" placeholder="Optional folder" />
      </div>
      <button class="btn" type="submit">Docs · Read</button>
    </form>

    <pre id="out">Awaiting request…</pre>
  </section>

  <script>
    const out = document.getElementById('out');
    const statusEl = document.getElementById('gStatus');
    const btnCheck = document.getElementById('btnCheck');

    // NEW: Status now uses backend API
    async function setStatus() {
      try {
        const r = await fetch('/api/google.js?op=status', { credentials: 'include' });
        const data = await r.json();
        if (data.connected) {
          statusEl.textContent = 'Google connected ✅';
          statusEl.className = 'ok';
          enableForms(true);
        } else {
          statusEl.textContent = 'Not connected ❌';
          statusEl.className = 'bad';
          enableForms(false);
        }
      } catch {
        statusEl.textContent = 'Not connected ❌';
        statusEl.className = 'bad';
        enableForms(false);
      }
    }

    // Enable/disable all forms based on connection status
    function enableForms(enable) {
      document.querySelectorAll('form input, form button').forEach(el => {
        el.disabled = !enable;
      });
    }

    setStatus();
    btnCheck.addEventListener('click', (e)=>{ e.preventDefault(); setStatus(); });

    async function postJSON(url, body) {
      const r = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(body || {})
      });
      const text = await r.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { raw:text }; }
      return { ok: r.ok, status: r.status, data };
    }
    function pretty(x) { try { return JSON.stringify(x, null, 2); } catch { return String(x); } }

    document.getElementById('formDriveList').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = {
        folderName: fd.get('folderName') || '',
        mimeType: fd.get('mimeType') || '',
        pageSize: 50
      };
      out.textContent = 'Searching…';
      const res = await postJSON('/api/workspace.js?action=drive.search', payload);
      out.textContent = pretty(res);
    });

    document.getElementById('formRead').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = {
        fileName: fd.get('fileName') || '',
        folderName: fd.get('folderName') || '',
        tab: fd.get('tab') || '',
        range: fd.get('range') || ''
      };
      out.textContent = 'Requesting…';
      const res = await postJSON('/api/workspace.js?action=sheets.read', payload);
      out.textContent = pretty(res);
    });

    document.getElementById('formUpdateCell').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = {
        fileName: fd.get('fileName') || '',
        folderName: fd.get('folderName') || '',
        tab: fd.get('tab') || '',
        cell: fd.get('cell') || '',
        value: fd.get('value') || ''
      };
      out.textContent = 'Updating…';
      const res = await postJSON('/api/workspace.js?action=sheets.updatecell', payload);
      out.textContent = pretty(res);
    });

    document.getElementById('formDocRead').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = {
        docName: fd.get('docName') || '',
        folderName: fd.get('folderName') || ''
      };
      out.textContent = 'Requesting…';
      const res = await postJSON('/api/workspace.js?action=docs.read', payload);
      out.textContent = pretty(res);
    });
  </script>
</body>
</html>
